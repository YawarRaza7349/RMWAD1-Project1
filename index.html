<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8"/>
	<title>Yawar Raza and Edward Finer's Rich Media Project 1</title>
	<script src="scripts/shapes.js"></script>
	<script src="scripts/Bumper.js"></script>
	<script src="scripts/Dot.js"></script>
</head>
<body>
	<canvas width="700" height="500">
		Your browser does not support the <code>canvas</code> element.
	</canvas>
</body>
<script>
	"use strict";
	var canvas, ctx, bumpers, dots, time, CANVAS_WIDTH, CANVAS_HEIGHT, NUM_DOTS;
	
	// Returns the distance between two given points
	function dist(x1, y1, x2, y2) {
		var dx = x2 - x1;
		var dy = y2 - y1;
		return Math.sqrt(dx * dx + dy * dy);
	}
	
	// Gets all objects in the scene that can collide with other objects
	function getCollidables() {
		return [].concat(bumpers, dots);
	}
	
	// Initialize state and event listeners, and kicks off game loop
	function init() {
		canvas = document.querySelector("canvas");
		ctx = canvas.getContext("2d");
		bumpers = [];
		dots = [];
		CANVAS_WIDTH = canvas.width;
		CANVAS_HEIGHT = canvas.height;
		NUM_DOTS = 20;
		for(var i = 0; i < NUM_DOTS; ++i) {
			dots.push(new Dot(Math.random() * CANVAS_WIDTH, Math.random() * CANVAS_HEIGHT, Math.random() * 50, Math.random() * 50, applyCircle));
		}
		window.addEventListener("mousedown", mouseDown);
		window.addEventListener("mouseup", mouseUp);
		time = Date.now();
		window.requestAnimationFrame(loop);
	}
	
	// Main game loop that runs every frame (as determined by Canvas)
	function loop() {
		var prevTime = time;
		time = Date.now();
		var dt = (time - prevTime) / 1000;
		ctx.fillStyle = "black";
		ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
		ctx.fillStyle = "white";
		ctx.strokeStyle = "black";
		bumpers.forEach(function(b) {
			b.update(dt);
			if(getCollidables().some(function(c) {
				return c !== b && c.collide(b);
			})) {
				b.stopGrowth();
			}
		});
		dots.forEach(function(d) {
			d.update(dt);
		});
		dots.forEach(function(d) {
			bumpers.some(function(b) {
				if(d.collide(b)) {
					d.nudge(b);
					d.reverse(); // TODO: Change me later to accurate non-shitty physics
					return true;
				}
				return false;
			});
		});
		dots.forEach(function(d) {
			d.bounceWalls(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
		});
		bumpers.forEach(function(b) {
			b.draw(ctx);
		});
		dots.forEach(function(d) {
			d.draw(ctx);
		});
		window.requestAnimationFrame(loop);
	}
	
	// Event handler for the mouse down action
	function mouseDown(e) {
		var x = e.clientX - canvas.offsetLeft;
		var y = e.clientY - canvas.offsetTop;
		bumpers.push(new Bumper(x, y, applyCircle));
	}
	
	// Event handler for the mouse up action
	function mouseUp(e) {
		var x = e.clientX - canvas.offsetLeft;
		var y = e.clientY - canvas.offsetTop;
		bumpers.forEach(function(b) {
			b.stopGrowth();
		});
	}
	
	window.addEventListener("load", init);
</script>
</html>